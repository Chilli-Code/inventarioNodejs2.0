
<head>
  <link href="https://cdn.jsdelivr.net/npm/gridstack@8.2.0/dist/gridstack.min.css" rel="stylesheet" />

  <style>
    @media (max-width: 768px) {
  body.is-mobile .grid-stack {
  width: 100%;
  height: auto;
  display: flex;
  gap: 20px;
  flex-direction: column;
}

body.is-mobile .grid-stack-item {
  height: auto;
  position: relative;
}

body.is-mobile .grid-stack-item-content {
  margin-top: 80px;
}

/* Estilos específicos si quieres para cada div */
body.is-mobile .divOne {
  margin-bottom: 90px !important;
  background-color: #29b6f6 !important;
  height: 1150px !important;
}

body.is-mobile .divTwo {
  height: 850px !important;
}

body.is-mobile .divThree {
  height: 300px !important;
}

  
}
.grid-stack-item .ui-resizable-se {
    right: 0px !important;
    bottom: 4px !important;
    width: 50px !important;
    height: 40px !important;
    /* background: rgb(209 25 25 / 20%); */
    border-radius: 4px;
    z-index: 10;
    cursor: se-resize;
}

.grid-stack-item-content{
  background-color: var(--app-content-secondary-color);
  border:1px solid var(--sidebar-active-link);
      border-radius: 8px;

}

  @media(max-width: 990px) {
    .container-mobile .swapy-container {
      display: flex !important;
      gap: 20px;
      width: 100%;
      flex-direction: column !important;
  }
  }
    .chart-card {
      padding: 20px;
      flex: 1;
      min-width: 300px;
      
    }
  
    .chart-card h2 {
      color: var(--app-content-main-color);
      margin-bottom: 15px;
      text-align: center;
    }
  .handle {
      cursor: grab;
      width: 24px;
      height: 24px;
      background-image: url("data:image/svg+xml,%3csvg%20viewBox='0%200%2024%2024'%20xmlns='http://www.w3.org/2000/svg'%20id='fi_3793594'%3e%3ccircle%20cx='8'%20cy='4'%20r='2'%3e%3c/circle%3e%3ccircle%20cx='8'%20cy='12'%20r='2'%3e%3c/circle%3e%3ccircle%20cx='8'%20cy='20'%20r='2'%3e%3c/circle%3e%3ccircle%20cx='16'%20cy='4'%20r='2'%3e%3c/circle%3e%3ccircle%20cx='16'%20cy='12'%20r='2'%3e%3c/circle%3e%3ccircle%20cx='16'%20cy='20'%20r='2'%3e%3c/circle%3e%3c/svg%3e");
      opacity: .5;
  
  }
  
  
  </style>
</head>
<%- include('./partials/header/layout') %>


    <%- include('./partials/navigation/navigation', {titleMain: titleMain}); %>
  </div>
  <%- include('./partials/statistics/statisticsHeader'); %>

  <div class="container-mobile" style="padding: 1rem 2rem; overflow: auto;">

<% if (user?.role === 'admin') { %>
  <%- include('./partials/admin/statistics/chartProducts', {productsByUser, allUsers, isMobile}) %>
  <%- include('./partials/admin/statistics/chartSellUser', {salesByUser, allUsers, isMobile}) %>
  <%- include('./partials/admin/statistics/chartDateUser', {clientSalesData, allUsers, isMobile}) %>

<% } else { %>
<div class="alert alert-info" style="background: #00002010; color: #29b6f6; border: 1px solid #29b6f6;">
  Estás viendo <strong>tus estadísticas personales</strong>.
</div>
  <div class="grid-stack">
    <div class="grid-stack-item divOne" gs-x="0" gs-y="0" gs-w="12" gs-h="16">
      <div class="grid-stack-item-content">
        <%- include('./partials/statistics/charts/DateSellUser') %>
      </div>
    </div>
    <div class="grid-stack-item divTwo" gs-x="0" gs-y="3" gs-w="6" gs-h="13">
      <div class="grid-stack-item-content">
        <%- include('./partials/statistics/charts/productos') %>
      </div>
    </div>
    <div class="grid-stack-item divThree" gs-x="6" gs-y="3" gs-w="6" gs-h="13" >
      <div class="grid-stack-item-content">
        <%- include('./partials/statistics/charts/categorias') %>
      </div>
    </div>
  </div>
<% } %>
</div>






<!-- Filtro para productos -->
<script>
const btnFiltrarProd = document.getElementById("filtrar-productos");
if (btnFiltrarProd) {
  btnFiltrarProd.addEventListener("click", () => {
const desde = document.getElementById("filtro-fecha-inicio")?.value;
const hasta = document.getElementById("filtro-fecha-fin")?.value;
const categoria = document.getElementById("filtro-categoria")?.value;
const top = document.getElementById("filtro-top")?.value;
const usuario = document.getElementById("filtro-usuario")?.value; 
console.log({ desde, hasta, categoria, top, usuario });
    fetch(`/api/grafica-productos?desde=${desde}&hasta=${hasta}&categoria=${categoria}&top=${top}&usuario=${usuario}`)
      .then(res => res.json())
      .then(data => {
        if (data.labels && data.data) {
          renderBarChart("#chart-productos", data.labels, data.data, "Productos");
        }
      })
      .catch(err => console.error("Error al filtrar productos:", err));
  });
}
</script>

<!-- Filtro para categorías -->
<script>
const btnFiltrarCat = document.getElementById("filtrar-categorias");
if (btnFiltrarCat) {
  btnFiltrarCat.addEventListener("click", () => {
    const categoria = document.getElementById("filtro-categoria-especifica")?.value;
    const url = categoria === "todas"
      ? `/api/grafica-categorias`
      : `/api/grafica-categorias?categoria=${encodeURIComponent(categoria)}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data.labels) && Array.isArray(data.data)) {
          renderBarChart("#chart-categorias", data.labels, data.data, "Categorías");
        } else {
          console.warn("Datos inválidos recibidos");
        }
      })
      .catch(err => {
        console.error("Error al filtrar categorías:", err);
        const chartElement = document.querySelector("#chart-categorias");
        if (chartElement) {
          chartElement.innerHTML = "<p style='text-align:center; color:red;'>Error al cargar datos.</p>";
        }
      });
  });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<!-- CDN de Swapy.js (usa el build adecuado si tienes uno) -->



    <script src="https://cdn.jsdelivr.net/npm/gridstack@8.2.0/dist/gridstack-all.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const isMobileDevice = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobileDevice) {
      document.body.classList.add('is-mobile');

      // Añade clases específicas a los grid-stack-items
      const items = document.querySelectorAll('.grid-stack-item');
      if (items.length >= 3) {
        items[0].classList.add('divOne');
        items[1].classList.add('divTwo');
        items[2].classList.add('divThree');
      }

      // Forzar que ocupen todo el ancho
      items.forEach(item => {
        item.setAttribute('gs-w', '12');
      });
    }

    // Inicializa GridStack
    GridStack.init({
      cellHeight: 60,
      float: false,
      oneColumnMode: isMobileDevice,
      oneColumnModeDomSort: true,
      resizable: {
        handles: 'se'
      },
      draggable: isMobileDevice ? false : {
        handle: '.handle',
        delay: 100,          // Espera 100ms antes de empezar a arrastrar
        distance: 5          // El cursor debe moverse 5px para activar el drag
      }
    });
  });
</script>




