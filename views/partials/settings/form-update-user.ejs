<div class="first">
  <div class="section-user-image">
    <div class="section-user-info">
      <% if (user) { %>
        <span class="user-name">
          <%= user.nombre %>
        </span>
        <% } %>
    </div>
    <% if (imageUrl) { %>
      <img src="<%= imageUrl %>" alt="Uploaded Image">
      <% } else if (user.profile_picture) { %>
        <img src="<%= user.profile_picture %>" alt="Profile Image">
        <% } else { %>
          <img src="/img/user.webp" alt="Default Profile Image">
          <% } %>

            <!-- <form action="/uploadP" method="POST" enctype="multipart/form-data">
              <a href="#" class="file" id="file-link">
                <svg viewBox="0 0 488.455 488.455" fill="currentColor" width="18" height="18">
                  <path
                    d="M287.396 216.317c23.845 23.845 23.845 62.505 0 86.35s-62.505 23.845-86.35 0-23.845-62.505 0-86.35 62.505-23.845 86.35 0">
                  </path>
                  <path
                    d="M427.397 91.581H385.21l-30.544-61.059H133.76l-30.515 61.089-42.127.075C27.533 91.746.193 119.115.164 152.715L0 396.86c0 33.675 27.384 61.074 61.059 61.074h366.338c33.675 0 61.059-27.384 61.059-61.059V152.639c-.001-33.674-27.385-61.058-61.059-61.058zM244.22 381.61c-67.335 0-122.118-54.783-122.118-122.118s54.783-122.118 122.118-122.118 122.118 54.783 122.118 122.118S311.555 381.61 244.22 381.61z">
                  </path>
                </svg>
              </a>
              <button style="margin-top: 10%;" class="app-content-headerButton filter-product"
                type="submit">Guardar</button>
              <input id="fileuploadimage" style="display: none;" type="file" name="picture" id="picture"
                accept=".jpg, .jpeg, .png">
            </form> -->
  </div>
</div>
<div class="last">
  <div class="config-data-user">
    <form id="settingsForm" method="POST" action="/settings/update">
      <h2 class="app-content-headerText">Editar Datos</h2>
      <p>
      <div class="cont-p">
        <p style="text-decoration: underline; color: #ff00009c;">Nota:</p>
        <p>Solo se puede cambiar una vez:
        </p>
        </div>
<input id="businessName" class="text" type="text" name="businessName" value="<%= user.businessName %>" maxlength="200"
  placeholder="Nombre de el Negocio" autocomplete="off">

      </p>
      <label style="margin-top:20px">Editar Ususario</label>
      <div class="cont-p">
        <p style="text-decoration: underline; color: #ff00009c;">Nota:</p>
        <p>Si desea cambiar Solo El Usario Complete este Campo</p>
      </div>
      <input class="btn-edit-info-user" placeholder="Nombre De Usuario" name="usuario">
      <label>Editar Contraseñas</label>
      <div class="cont-p">
        <p style="text-decoration: underline; color: #ff00009c;">Nota:</p>
        <p>Si desea cambiar Solo la Contraseña Complete estos Dos Campos</p>
      </div>
      <input type="password" id="current-password" name="currentPassword" placeholder="Contraseña Actual">
      <input class="btn-change-pass sss" type="password" name="newPassword" placeholder="Nueva Contraseña">
      <button class="app-content-headerButton filter-product" type="submit">Actualizar Datos</button>
    </form>
  </div>
</div>

<script>
document.getElementById('settingsForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const data = {
    businessName: e.target.businessName.value,
    usuario: e.target.usuario.value,
    currentPassword: e.target.currentPassword.value,
    newPassword: e.target.newPassword.value,
  };

  try {
const res = await fetch('/settings/update', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'same-origin',  // <--- Esta línea es clave para enviar cookies
  body: JSON.stringify(data),
});


    const result = await res.json();

    if (res.ok) {
      // Mostrar alerta y recargar la página para que se actualicen los datos
      Swal.fire({
        title: '¡Éxito!',
        html: `<lottie-player src="/Lottie/ProfileUpdate.json" background="transparent" speed="1" style="width:150px; height:150px; margin:0 auto;" autoplay></lottie-player><p>${result.message}</p>`,
        confirmButtonText: 'Aceptar'
      }).then(() => {
        window.location.reload();  // <--- recarga la página para traer los datos actualizados
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        html: `<lottie-player src="/Lottie/userOps.json" background="transparent" speed="1" style="width:150px; height:150px; margin:0 auto;" autoplay></lottie-player><p>${result.message}</p>`,
        confirmButtonText: 'Aceptar'
      });
    }
  } catch (error) {
    Swal.fire('Error', 'Error al conectar con el servidor.', 'error');
  }
});


</script>
